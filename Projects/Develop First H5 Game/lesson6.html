<html>
    <head>
        <style type="text/css">
        #cav{border:solid 1px #E1E1E1;}
        @font-face {
            font-family: "DS-Digital";
            src: url("fonts/Ds-digib.ttf");
        }
        </style>
    </head>
    <body>
        <canvas id="cav" width="624" height="624">            
        </canvas>
        <script type="text/javascript">
            function Map(w,h,cSize){
                this.winW=w;
                this.winH=h;
                this.cellSize=24;
                this.cSize=cSize;
                this.maps=[];
                var imgsrc=["images/brick.png","images/steel.png","images/water.png","images/forest.png"];
                this.imgRes=[];
                for(var i=0;i<imgsrc.length;i++){
                    this.imgRes[i]=new Image();
                    this.imgRes[i].src=imgsrc[i];
                }
            }

            Map.prototype.load=function(maps){
                this.maps=maps;
            };

            Map.prototype.draw=function(ctx){
                ctx.fillStyle="#333333";
                ctx.fillRect(0,0,this.winW,this.winH);
                for(var r=0;r<this.maps.length;r++){
                    for(var c=0;c<this.maps[r].length;c++){
                        if(this.maps[c][r]==0) continue;
                        ctx.drawImage(this.imgRes[this.maps[c][r]-1],0,0,this.cellSize,this.cellSize,this.cSize*r,this.cSize*c,this.cSize,this.cSize);
                    }
                }
            };

            function KeyMonitor(){
                this.status={};
                this.onKeyDown=function(e){
                    debugger;
                    this.status[keyCode]=true;
                };

                this.onKeyUp=function(e){
                    debugger;
                    this.status[keyCode]=false;
                };

                this.keyPressed=function(code){
                    return this.status.hasOwnProperty(code) && this.status[code];
                };
            }

            function Tank(x,y,cSize){
                this.x=x;
                this.y=y;
                this.cSize=cSize;
                this.dir=0;//rlud
                this.img=new Image();
                this.img.src="images/tank.png";
            }

            Tank.prototype.draw=function(ctx){
                ctx.drawImage(this.img,this.dir*48,0,48,48,this.x,this.y,this.cSize,this.cSize);
            };

            Tank.prototype.updateDir=function(){

            };

            function Game(node){
                var w=624;
                var h=624;
                this.node=node;
                this.ctx=node.getContext("2d");                
                this.handler=null;
                this.prevTime=0;
                this.keyMonitor=new KeyMonitor();
                this.map=new Map(w,h,w/26);
                this.hero=new Tank(w/26*9,24*w/26,48);
                this.init=function(){
                    this.bindMouseDown=(function(scope){
                        var self=scope;
                        return function(e){
                            self.onMouseDown.call(self,e);
                        }
                    })(this);

                    this.bindMouseMove=(function(scope){
                        var self=scope;
                        return function(e){
                            self.onMouseMove.call(self,e);
                        }
                    })(this);

                    this.bindMouseUp=(function(scope){
                        var self=scope;
                        return function(e){
                            self.onMouseUp.call(self,e);
                        }
                    })(this);
                    
                    this.bindKeyDown=(function(scope){
                        var self=scope;
                        return function(e){
                            self.onKeyDown.call(self,e);
                        };
                    })(this);

                    this.bindKeyUp=(function(scope){
                        var self=scope;
                        return function(e){
                            self.onKeyUp.call(self,e);
                        };
                    })(this);

                    this.mainLoop=(function(scope){
                        var self=scope;
                        return function(e){
                            self.update.call(self);
                        }
                    })(this);
                    this.map.load([
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0],
                        [0, 0, 1, 1, 4, 4, 4, 4, 0, 0, 2, 2, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 1, 1, 4, 4, 4, 4, 0, 0, 2, 2, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 4, 4, 4, 4, 1, 1, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 0, 0, 2, 2, 0, 0],
                        [0, 0, 0, 0, 4, 4, 4, 4, 1, 1, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 0, 0, 2, 2, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 1, 1, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 1, 1, 0, 0, 0, 0],
                        [0, 0, 2, 2, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 2, 2, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [3, 3, 3, 3, 1, 1, 0, 0, 4, 4, 4, 4, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0],
                        [3, 3, 3, 3, 1, 1, 0, 0, 4, 4, 4, 4, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0],
                        [3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 2, 2],
                        [3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 2, 2],
                        [0, 0, 1, 1, 4, 4, 4, 4, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 1, 1, 4, 4, 4, 4, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [2, 2, 0, 0, 4, 4, 4, 4, 3, 3, 3, 3, 4, 4, 4, 4, 3, 3, 3, 3, 0, 0, 1, 1, 0, 0],
                        [2, 2, 0, 0, 4, 4, 4, 4, 3, 3, 3, 3, 4, 4, 4, 4, 3, 3, 3, 3, 0, 0, 1, 1, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 0, 0, 4, 4, 4, 4, 3, 3, 3, 3, 4, 4, 4, 4, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 0, 0, 4, 4, 4, 4, 3, 3, 3, 3, 4, 4, 4, 4, 0, 0],
                        [0, 0, 0, 0, 0, 0, 2, 2, 3, 3, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 4, 4, 4, 4, 0, 0],
                        [0, 0, 0, 0, 0, 0, 2, 2, 3, 3, 0, 0, 0, 0, 0, 0, 3, 3, 3, 3, 4, 4, 4, 4, 0, 0],
                        [0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 1, 2, 2, 0, 0, 0, 0],
                        [1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 1, 2, 2, 0, 0, 0, 0]
                    ]);
                    this.regEvents();
                    this.prevTime=performance.now();
                    this.update();
                }

                this.regEvents=function(){
                    this.node.addEventListener("mousedown",this.bindMouseDown);
                    this.node.addEventListener("mouseup",this.bindMouseUp)
                    this.node.addEventListener("mousemove",this.bindMouseMove);
                    this.node.addEventListener("keyup",this.bindKeyUp);
                    this.node.addEventListener("keydown",this.bindKeyDown);
                };
                this.getCursorPoint=function(e){
                    return {x:e.offsetX,y:e.offsetY};
                }

                this.onMouseDown=function(e){
                    var pos=this.getCursorPoint(e);
                };

                this.onMouseMove=function(e){
                    var pos=this.getCursorPoint(e);
                };

                this.onMouseUp=function(e){
                    this.selectNode=null;
                    var pos=this.getCursorPoint(e);                    
                };

                this.onKeyDown=function(e){
                    this.keyMonitor.onKeyDown(e);
                };

                this.onKeyUp=function(e){
                    this.keyMonitor.onKeyUp(e);
                };

                this.update=function(){
                    window.cancelAnimationFrame(this.handler);
                    var now=performance.now();
                    this.ctx.clearRect(0,0,w,h);
                    this.map.draw(this.ctx);
                    this.hero.draw(this.ctx);
                    this.prevTime=now;
                    this.handler=window.requestAnimationFrame(this.mainLoop);
                };
            }
            var game=new Game(document.getElementById("cav"));
            game.init();
        </script>
    </body>
</html>