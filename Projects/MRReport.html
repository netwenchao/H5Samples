<html>
    <head>
        <style type="text/css">
        table{border-collapse: collapse;}
        td,th{border:solid 1px #000;}
        </style>
        <script type="text/javascript" src="jquery-1.7.2.min.js"></script>
        <script type="text/javascript">
            var report={
                "Id": "bd377d50-16a2-4518-91a3-d31fee0f802a",
                "Name": "MR-技师",
                "Code": "MR-JS",
                "GroupFields": [{
                    "TemplateId": null,
                    "FieldName": "DeviceId",
                    "Type": "String",
                    "GroupType": "0",
                    "Display": "设备",
                    "IncludeNull": false,
                    "DisplayName": null,
                    "RangeFieldData": null
                }, {
                    "TemplateId": null,
                    "FieldName": "ExecDoctorId",
                    "Type": "String",
                    "GroupType": "0",
                    "Display": "拍片医师",
                    "IncludeNull": false,
                    "DisplayName": null,
                    "RangeFieldData": null
                }, {
                    "TemplateId": null,
                    "FieldName": "StatisticTimeParts.WeekDayType",
                    "Type": "Int32",
                    "GroupType": "0",
                    "Display": "周类型",
                    "IncludeNull": false,
                    "DisplayName": null,
                    "RangeFieldData": null
                }],
                "FilterFields": [{
                    "FieldName": "ModalityId",
                    "Type": "String",
                    "Display": "设备类型"
                }],
                "AggregateFields": [{
                    "FieldName": "OrderCount",
                    "Type": "Int32",
                    "Display": "数量"
                }],
                "IsPublic": false,
                "IsHidden": false,
                "CreateDateTime": null,
                "UpdateDateTime": null,
                "CreateDoctorId": "5dda0a0a-b947-49fc-b13e-34a068bfba21",
                "CategoryId": "aa36e59f-8f52-456f-8808-da28d0e45c81",
                "FilterParams": "[{\"FieldName\":\"ModalityId\",\"ExactValues\":[\"15a0f0cb-6b44-45fe-a9d5-54d7464c1e4e\"]}]",
                "DefaultTimeField": "RegisterTime",
                "SysMatchFields": null,
                "EnableRowConversion": true
            };
            var data =[{
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b0e", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e08", "0"],
                "Count": 0,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "6"
                }],
                "Message": null
            }, {
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b0e", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e08", "1"],
                "Count": 1,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "2"
                }],
                "Message": null
            }, {
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b0e", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e08", "2"],
                "Count": 2,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "2"
                }],
                "Message": null
            },{
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b01", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e08", "0"],
                "Count": 0,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "6"
                }],
                "Message": null
            }, {
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b01", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e08", "1"],
                "Count": 1,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "2"
                }],
                "Message": null
            }, {
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b01", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e08", "2"],
                "Count": 2,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "2"
                }],
                "Message": null
            },{
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b01", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e07", "0"],
                "Count": 0,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "6"
                }],
                "Message": null
            }, {
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b01", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e07", "1"],
                "Count": 1,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "2"
                }],
                "Message": null
            }, {
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b01", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e07", "2"],
                "Count": 2,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "2"
                }],
                "Message": null
            }, {
                "Result": true,
                "GroupFields": ["20fc2706-dd53-4129-aba2-7803b1848b0d", "e0a64f3b-1350-4c75-8d6c-2ba0b3d52e09", "2"],
                "Count": 2,
                "AggregateResult": [{
                    "Key": "OrderCount",
                    "Value": "2"
                }],
                "Message": null
            }];

            String.prototype.format=function(){
                var arg=arguments;
                return this.replace(/\{(\d+)\}/ig,function(match,idx){
                    var i=parseInt(idx);
                    if(!isNaN(i)){
                        return i<arg.length?arg[i]:"";
                    }
                    return "";
                });
            };
        </script>
    </head>
    <body>
        <div id="output"></div>
        <script type="text/javascript">
            /*
/*
 * 分组字段>=2
 */
 ; var reportEngine_RowConversion = (function () {
    function DictArray() {
        var dict = {};
        this.items = [];
        var keyPreFix = "$$";
        var self = this;
        this.length = 0;
        this.add = function (val) {
            var k = keyPreFix + (val !== 0 ? (val || "") : 0);
            if (!dict.hasOwnProperty(k)) {
                dict[k] = val;
                self.items.push(val);
                self.length++;
            }
        };
        return this;
    }
    var __converter = null;
    function generateOutput(dataItems, report) {
        if (report.GroupFields.length < 2) {
            //todo render using defaultEngine
            return;
        }

        var rowData = {};
        var colGroup = {};
        var groupFields = report.GroupFields;
        var aggFields = report.AggregateFields;
        var gpMaxIdx = groupFields.length - 1;

        var kPrefix = "$";
        //convert data basedon fst Group field.
        $(dataItems).each(function () {
            var item = this;
            var curO = null;
            for (var gIdx = 0; gIdx < groupFields.length; gIdx++) {
                var key = "$" + (item.GroupFields[gIdx] !== 0 ? (item.GroupFields[gIdx] || "") : "0");
                if (gIdx == 0) {
                    !rowData.hasOwnProperty(key) && (rowData[key] = {});
                    curO = rowData[key];
                } else if (gIdx == gpMaxIdx) {
                    !curO[key] && (curO[key] = {});
                    curO = curO[key];
                    for (var aIdx = 0; aIdx < aggFields.length; aIdx++) {
                        curO[aggFields[aIdx].FieldName] = item.AggregateResult[aIdx].Value;
                    }
                } else {
                    !curO[key] && (curO[key] = {});
                    curO = curO[key];
                }

                if (gIdx != 0) {
                    !colGroup.hasOwnProperty(groupFields[gIdx].FieldName) && (colGroup[groupFields[gIdx].FieldName] = new DictArray());
                    colGroup[groupFields[gIdx].FieldName].add(item.GroupFields[gIdx]);
                }
            }
        });

        function procNode(lev, node,summary) {
            if (lev == groupFields.length) {
                //Todo build using count fields
                for (var i = 0; i < aggFields.length; i++) {
                    var key = aggFields[i].FieldName;
                    !node.hasOwnProperty(key) && (node[key] = 0);
                    !summary.hasOwnProperty(key) && (summary[key]=0);
                    var val=parseInt(node[key]);
                    if(!isNaN(val)){
                        summary[key]+=val;
                    }
                }
            } else {
                var gpData = colGroup[groupFields[lev].FieldName];
                for (var i = 0; i < gpData.items.length; i++) {
                    var key = kPrefix + (gpData.items[i] !== 0 ? (gpData.items[i] || "") : "0");
                    !node.hasOwnProperty(key) && (node[key] = {});
                    !summary.hasOwnProperty(key) && (summary[key]={});
                    procNode(lev + 1, node[key],summary[key])
                }
            }
        }

        var summaryRow={};
        //Build missing data
        for (var k in rowData) {
            if (rowData.hasOwnProperty(k)) {
                var fstLev = rowData[k];//devlev
                procNode(1, fstLev,summaryRow);
            }
        }

        console.log(rowData);
        console.log(summaryRow);        
        console.log(colGroup);

        var output = {
            header: [],
            body: [],
            foot: [],
            getOutPut: function () {
                return "<table class=\"reportDataTable headerCenter\" style=\"text-align:center;\"><thead>{0}</thead><tbody>{1}</tbody><tfoot>{2}</tfoot></table>".format(this.header.join("\r\n"), this.body.join("\r\n"), this.foot.join("\r\n"));
            }
        };

        function getFieldValue(val, fieldName) {
            return __converter.convert(fieldName,val);
        }

        var colSpans = [];
        for (var i = groupFields.length - 1; i > 0; i--) {
            if (i == groupFields.length - 1) {
                colSpans[i] = aggFields.length;
            } else {
                colSpans[i] = colSpans[i + 1] * colGroup[groupFields[i + 1].FieldName].length;
            }
        }

        var headerRow = [];
        for (var i = 1; i < groupFields.length; i++) {
            var vals = colGroup[groupFields[i].FieldName].items;
            var parentSize =i==1?1:colGroup[groupFields[i-1].FieldName].items.length;
            var colSpan = colSpans[i] || 0;
            var cells = [];
            for (var c = 0; c < parentSize; c++) {
                for (var idx = 0; idx < vals.length; idx++) {
                    if (colSpan > 1) {
                        cells.push("<th colspan=\"{1}\">{0}</th>".format(getFieldValue(vals[idx], groupFields[i].FieldName), colSpan));
                    } else {
                        cells.push("<th>{0}</th>".format(getFieldValue(vals[idx], groupFields[i].FieldName)));
                    }
                }
            }
            headerRow[i] = cells;
        }

        if (aggFields.length > 1) {
            var aggCells = [];
            var groupRows = headerRow[headerRow.length - 1].length;
            for (var i = 0; i < groupRows; i++) {
                $(aggFields).each(function () {
                    aggCells.push("<th>{0}</th>".format(ris_utils.htmlEncode(this.Display)));
                });
            }
            headerRow.push(aggCells);
        }

        $(headerRow).each(function (i, item) {
            if (!item) return true;
            if (i == 1) {
                output.header.push("<tr><th rowspan=\"{0}\">{1}</th>{2}</tr>".format(groupFields.length - 1 + (aggFields.length - 1), groupFields[0].DisplayName || groupFields[0].Display, item.join("\r\n")));
            } else {
                output.header.push("<tr>{0}</tr>".format(item.join("\r\n")));
            }
        });

        function getCellHtml(obj, arr, lev) {
            if (lev == groupFields.length) {
                //using count fields
                for (var i = 0; i < aggFields.length; i++) {
                    var key = aggFields[i].FieldName;
                    arr.push("<td>{0}</td>".format(obj[key]));
                }
            } else {
                var gpData = colGroup[groupFields[lev].FieldName];
                for (var i = 0; i < gpData.items.length; i++) {
                    var key = kPrefix + (gpData.items[i] !== 0 ? (gpData.items[i] || "") : "0");
                    getCellHtml(obj[key], arr, lev + 1);
                }
            }
        }

        for (var k in rowData) {
            if (rowData.hasOwnProperty(k)) {
                var rowHtml = []
                getCellHtml(rowData[k], rowHtml, 1)
                output.body.push("<tr><td>{0}</td>{1}</tr>".format(getFieldValue(k.substr(1), groupFields[0].FieldName), rowHtml.join("\r\n")));
            }
        }
        //summaryRow
        var footHtmls=[];
        getCellHtml(summaryRow,footHtmls,1);
        output.foot.push("<tr><td>{0}</td>{1}</tr>".format("总计",footHtmls.join("\r\n")));
        return output.getOutPut();
    }

    return {
        setConverter: function (convert) {
            __converter = convert
        },
        generateReport: function (target, data, matchFields, params,report) {
            $(target).html(generateOutput(data, report));
        }
    }
})();

reportEngine_RowConversion.setConverter({convert:function(v,f){
return v+f;
}});
reportEngine_RowConversion.generateReport($("#output"),data,null,null,report);

        </script>
    </body>
</html>